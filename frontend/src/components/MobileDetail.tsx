import "leaflet/dist/leaflet.css";
import { useState, useContext, useEffect } from "react";
import "../general.css";
import PostForm from "./PostForm";
import Comment from "./Comment";
import { AuthContext } from "../context/AuthContext";
import heartFilled from "../assets/heartFilled.png";
import heartNot from "../assets/heartNot.png";
import pen from "../assets/pen.png";
import garbage from "../assets/garbage.png";
import check from "../assets/check.png";
import back from "../assets/back.png";
import heartGray from "../assets/heartGray.png";
import { formatDateToYYYYMMDD } from "../utils/format";
import React from "react";
import { UserData } from "../types/user";

interface EditedPost {
    post_title?: string;
    description?: string;
}

interface MobileDetailProps {
    post: Post;
    handleLikeClick: (id: string, isLiked: boolean) => void;
    handleEditClick: (
        post: Post,
        e: React.MouseEvent<HTMLButtonElement>
    ) => void;
    handleDeleteClick: (
        id: string,
        e: React.MouseEvent<HTMLButtonElement>
    ) => void;
    handleCancelClick: (e: React.MouseEvent<HTMLButtonElement>) => void;
    handleSaveClick: (
        id: string,
        e: React.MouseEvent<HTMLButtonElement>
    ) => void;
    isCurrentUserPost: boolean;
    isLoggedIn: boolean | UserData | null;
    editingPostId: string | null;
    setEditingPostId: React.Dispatch<React.SetStateAction<string | null>>;
    setEditedPost: React.Dispatch<React.SetStateAction<EditedPost | null>>;
    editedPost: EditedPost | null;
}

const MobileDetail: React.FC<MobileDetailProps> = ({
    post,
    handleLikeClick,
    handleEditClick,
    handleDeleteClick,
    handleCancelClick,
    handleSaveClick,
    isLoggedIn,
    editingPostId,
    setEditingPostId,
    setEditedPost,
    editedPost,
    isCurrentUserPost,
}) => {
    return (
        <>
            <button className="mobile-button">Toggle Bottom Sheet</button>
            <div className="popup-content">
                {editingPostId === post.id ? (
                    <input
                        type="text"
                        value={editedPost?.post_title || ""}
                        onChange={(e) =>
                            setEditedPost({
                                ...editedPost,
                                post_title: e.target.value,
                            })
                        }
                    />
                ) : (
                    <h3 className="popup-title">{post.post_title}</h3>
                )}
                <div className="post-info">
                    <div className="post-crated">
                        <p>
                            {post.nickname && (
                                <>
                                    by {post.nickname}
                                    &emsp;
                                </>
                            )}
                            {formatDateToYYYYMMDD(post.created_at)}
                        </p>
                    </div>
                    {isCurrentUserPost &&
                        (editingPostId === post.id ? (
                            <div className="post-opt">
                                <button onClick={(e) => handleCancelClick(e)}>
                                    <img src={back} className="back-img" />
                                </button>
                                <button
                                    onClick={(e) => handleSaveClick(post.id, e)}
                                >
                                    <img src={check} className="check-img" />
                                </button>
                            </div>
                        ) : (
                            <div className="post-opt">
                                <button
                                    onClick={(e) => handleEditClick(post, e)}
                                >
                                    <img src={pen} className="pen-img" />
                                </button>
                                <button
                                    onClick={(e) =>
                                        handleDeleteClick(post.id, e)
                                    }
                                >
                                    <img
                                        src={garbage}
                                        className="garbage-img"
                                    />
                                </button>
                            </div>
                        ))}

                    {isLoggedIn ? (
                        <div className="post-like">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    handleLikeClick(post.id, post.is_liked);
                                }}
                            >
                                {post.is_liked ? (
                                    <img
                                        src={heartFilled}
                                        className="heart-img"
                                    />
                                ) : (
                                    <img src={heartNot} className="heart-img" />
                                )}
                            </button>
                            <p>{post.like_count}</p>
                        </div>
                    ) : (
                        <div className="post-like">
                            <img src={heartGray} className="heart-gray-img" />
                            <p>{post.like_count}</p>
                        </div>
                    )}
                </div>
                <div className="popup-body">
                    <img src={post.imageUrl} className="popup-image" />
                    <div className="popup-text">
                        <div className="description">
                            {editingPostId === post.id ? (
                                <textarea
                                    value={editedPost?.description || ""}
                                    onChange={(e) =>
                                        setEditedPost({
                                            ...editedPost,
                                            description: e.target.value,
                                        })
                                    }
                                />
                            ) : (
                                <p>{post.description}</p>
                            )}
                        </div>
                        <Comment id={post.id} />
                    </div>
                </div>
            </div>
        </>
    );
};

export default MobileDetail;
